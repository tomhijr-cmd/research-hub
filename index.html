<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Research Hub â€” HRI Paper Feed</title>

  <!-- â”€â”€ Firebase SDK (compat mode = no bundler needed, works in plain HTML) â”€â”€ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    /* â”€â”€ CSS Custom Properties (theme variables) â”€â”€ */
    :root {
      --bg:           #f5f4f0;
      --surface:      #ffffff;
      --border:       #ddd9d0;
      --text:         #1a1a1a;
      --text-muted:   #666;
      --accent:       #2c5f8a;
      --accent-light: #e8f0f8;
      --tag-bg:       #eef2f7;
      --tag-off:      #f0f0f0;
      --tag-off-text: #999;
      --score-high:   #2d7a3a;
      --score-mid:    #8a6d2c;
      --score-low:    #999;
      --shadow:       0 1px 3px rgba(0,0,0,0.08);
      --radius:       6px;
      --font-serif:   Georgia, 'Times New Roman', serif;
      --font-sans:    system-ui, -apple-system, sans-serif;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --bg:           #1a1a1e;
      --surface:      #25252b;
      --border:       #38383f;
      --text:         #e8e8e8;
      --text-muted:   #999;
      --accent:       #6aabda;
      --accent-light: #1e2d3d;
      --tag-bg:       #2a3540;
      --tag-off:      #2a2a2f;
      --tag-off-text: #666;
      --score-high:   #5cb86a;
      --score-mid:    #c9a84c;
      --score-low:    #666;
      --shadow:       0 1px 4px rgba(0,0,0,0.3);
    }

    /* â”€â”€ Reset & Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }

    /* â”€â”€ Layout â”€â”€ */
    .app-wrapper {
      max-width: 860px;
      margin: 0 auto;
      padding: 0 16px 60px;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 0 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .header-title h1 {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      font-weight: normal;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .header-title p {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* â”€â”€ Buttons â”€â”€ */
    button {
      cursor: pointer;
      font-family: var(--font-sans);
      border: none;
      border-radius: var(--radius);
      transition: opacity 0.15s, background 0.15s;
    }

    button:hover { opacity: 0.85; }
    button:active { opacity: 0.7; }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      padding: 7px 14px;
      font-size: 0.85rem;
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 7px 14px;
      font-size: 0.85rem;
    }

    .btn-icon {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 10px;
      font-size: 1rem;
      line-height: 1;
    }

    /* Spinning animation for refresh button when loading */
    .btn-spinning { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Auth area styles â”€â”€ */

    /* Google sign-in button */
    .btn-signin {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 6px 12px;
      font-size: 0.82rem;
      font-weight: 500;
      white-space: nowrap;
      box-shadow: var(--shadow);
    }

    .btn-signin svg {
      flex-shrink: 0;
    }

    /* Signed-in user display */
    .auth-user {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    /* Fallback avatar when no photo */
    .user-avatar-fallback {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user-name {
      font-size: 0.82rem;
      color: var(--text-muted);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-signout {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-decoration: underline;
      padding: 0;
      cursor: pointer;
    }

    .btn-signout:hover { color: var(--text); opacity: 1; }

    /* Hint shown in settings panel when signed out */
    .signin-notice {
      font-style: italic;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    /* Dim the add-keyword row when signed out */
    .add-keyword-row.disabled {
      opacity: 0.45;
      pointer-events: none;
    }

    /* â”€â”€ Settings Panel â”€â”€ */
    .settings-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      display: none; /* hidden by default, toggled by JS */
    }

    .settings-panel.open { display: block; }

    .settings-panel h2 {
      font-family: var(--font-serif);
      font-size: 1rem;
      font-weight: normal;
      margin-bottom: 14px;
      color: var(--text);
    }

    /* Keyword chips container */
    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      min-height: 36px;
    }

    /* Each keyword is a toggle chip */
    .keyword-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--tag-bg);
      color: var(--accent);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 10px 4px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s, color 0.15s;
    }

    /* Disabled/off chip style */
    .keyword-chip.off {
      background: var(--tag-off);
      color: var(--tag-off-text);
      border-color: var(--border);
      text-decoration: line-through;
    }

    /* The Ã— remove button inside each chip */
    .keyword-chip .remove-btn {
      background: none;
      border: none;
      color: inherit;
      font-size: 1rem;
      line-height: 1;
      padding: 0 0 0 2px;
      opacity: 0.5;
      cursor: pointer;
    }

    .keyword-chip .remove-btn:hover { opacity: 1; }

    /* Add keyword input row */
    .add-keyword-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .add-keyword-row input {
      flex: 1;
      font-family: var(--font-sans);
      font-size: 0.85rem;
      padding: 7px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
      outline: none;
    }

    .add-keyword-row input:focus { border-color: var(--accent); }

    /* â”€â”€ Active keyword tags shown below header â”€â”€ */
    .active-keywords-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 20px;
      align-items: center;
    }

    .active-keywords-bar .bar-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-right: 4px;
    }

    .active-kw-tag {
      background: var(--accent-light);
      color: var(--accent);
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 0.75rem;
    }

    /* â”€â”€ Status / error messages â”€â”€ */
    .status-bar {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      min-height: 20px;
    }

    .status-bar.error { color: #c0392b; }

    /* â”€â”€ Paper Feed â”€â”€ */
    .paper-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Individual paper card */
    .paper-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 22px;
      box-shadow: var(--shadow);
      transition: box-shadow 0.15s;
    }

    .paper-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }

    .paper-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .paper-title {
      font-family: var(--font-serif);
      font-size: 1.05rem;
      line-height: 1.4;
      color: var(--text);
      flex: 1;
    }

    .paper-title a {
      color: inherit;
      text-decoration: none;
    }

    .paper-title a:hover { color: var(--accent); text-decoration: underline; }

    /* Score badge */
    .score-badge {
      flex-shrink: 0;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 12px;
      background: var(--tag-bg);
      color: var(--score-low);
      white-space: nowrap;
    }

    .score-badge.high { color: var(--score-high); background: #eef6ef; }
    .score-badge.mid  { color: var(--score-mid);  background: #f6f2ea; }

    [data-theme="dark"] .score-badge.high { background: #1a2e1c; }
    [data-theme="dark"] .score-badge.mid  { background: #2c2718; }

    .paper-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .paper-abstract {
      font-size: 0.88rem;
      color: var(--text);
      line-height: 1.65;
      /* Show first ~4 lines, expandable */
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .paper-abstract.expanded {
      display: block;
      -webkit-line-clamp: unset;
    }

    .expand-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.78rem;
      padding: 4px 0;
      margin-top: 4px;
      cursor: pointer;
      display: inline-block;
    }

    .expand-btn:hover { text-decoration: underline; opacity: 1; }

    /* â”€â”€ Empty / loading states â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .empty-state .icon { font-size: 2.5rem; margin-bottom: 12px; }

    /* â”€â”€ Skeleton loading cards â”€â”€ */
    .skeleton-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 22px;
    }

    .skeleton-line {
      background: var(--border);
      border-radius: 4px;
      margin-bottom: 10px;
      animation: pulse 1.4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.5; }
    }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      margin-top: 40px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* â”€â”€ Health / system status bar (bottom of page) â”€â”€ */
    .health-bar {
      margin-top: 12px;
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 0.72rem;
      display: inline-block;
      background: var(--tag-bg);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .health-bar.ok    { color: var(--score-high); background: #eef6ef; border-color: #c3e0c7; }
    .health-bar.error { color: #c0392b;           background: #fdf0ef; border-color: #f0c4c0; }

    [data-theme="dark"] .health-bar.ok    { background: #1a2e1c; border-color: #2d4d30; }
    [data-theme="dark"] .health-bar.error { background: #2e1a1a; border-color: #4d2d2d; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 600px) {
      .header-title h1 { font-size: 1.2rem; }
      .paper-card { padding: 16px; }
      .paper-title { font-size: 0.95rem; }
    }
  </style>
</head>
<body>

<div class="app-wrapper">

  <!-- â”€â”€ Header â”€â”€ -->
  <header>
    <div class="header-title">
      <h1>Research Hub</h1>
      <p>HRI Paper Feed â€” Semantic Scholar</p>
    </div>
    <div class="header-actions">
      <!-- Auth area: shows sign-in button OR avatar + name + sign-out -->
      <div class="auth-area" id="authArea"></div>
      <!-- Refresh button â€” its inner span spins while loading -->
      <button class="btn-icon" id="refreshBtn" title="Fetch new papers" aria-label="Refresh papers">
        <span id="refreshIcon">â†»</span>
      </button>
      <!-- Dark/light mode toggle -->
      <button class="btn-icon" id="themeBtn" title="Toggle dark/light mode" aria-label="Toggle theme">ğŸŒ™</button>
      <!-- Settings toggle -->
      <button class="btn-secondary" id="settingsToggle">âš™ Keywords</button>
    </div>
  </header>

  <!-- â”€â”€ Settings Panel (hidden by default) â”€â”€ -->
  <section class="settings-panel" id="settingsPanel" aria-label="Keyword settings">
    <h2>Search Keywords</h2>
    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:14px;">
      Click a keyword to toggle it on/off. Active keywords are used to fetch and score papers.
      The Ã— button removes a keyword entirely.
    </p>

    <!-- Sign-in hint shown only when signed out -->
    <p class="signin-notice" id="signinNotice" style="display:none;">
      Sign in with Google to save your keywords across devices.
    </p>

    <!-- Keyword chips are rendered here by JS -->
    <div class="keyword-list" id="keywordList"></div>

    <!-- Add new keyword â€” disabled (dimmed) when signed out -->
    <div class="add-keyword-row" id="addKeywordRow">
      <input type="text" id="newKeywordInput" placeholder="Add a keywordâ€¦" maxlength="80" aria-label="New keyword" />
      <button class="btn-primary" id="addKeywordBtn">Add</button>
    </div>
  </section>

  <!-- â”€â”€ Active keyword tags shown in feed view â”€â”€ -->
  <div class="active-keywords-bar" id="activeKeywordsBar"></div>

  <!-- â”€â”€ Status line â”€â”€ -->
  <div class="status-bar" id="statusBar"></div>

  <!-- â”€â”€ Paper feed â”€â”€ -->
  <main class="paper-feed" id="paperFeed" aria-live="polite"></main>

  <footer>
    Data from <a href="https://www.semanticscholar.org/" target="_blank" rel="noopener" style="color:var(--accent)">Semantic Scholar</a>
    â€” open and free academic search API.
    <div id="healthBar" class="health-bar" style="display:none;"></div>
  </footer>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Research Hub â€” HRI Paper Feed
//  Single-file vanilla JS app. No frameworks, no build step.
//  Keywords sync to Firestore when signed in; localStorage
//  is kept for theme and health check state only.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Firebase setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// firebaseConfig is safe to embed in client HTML â€” it's a project
// identifier, not a secret. Security is enforced by Firestore Rules
// (each user can only read/write their own document).

const firebaseConfig = {
  apiKey:            'AIzaSyCGeXjURWaP02MdENQIR5wjQJdmapyAEPo',
  authDomain:        'research-hub-8da6a.firebaseapp.com',
  projectId:         'research-hub-8da6a',
  storageBucket:     'research-hub-8da6a.firebasestorage.app',
  messagingSenderId: '765872653008',
  appId:             '1:765872653008:web:ea08868e0e59e86acb14d5',
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// Holds the signed-in Firebase User object, or null if signed out.
let currentUser = null;


// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const THEME_KEY      = 'researchhub_theme';
const LAST_FETCH_KEY = 'researchhub_last_fetch'; // ISO timestamp of last successful fetch
const HEALTH_KEY     = 'researchhub_health';     // last health check result {ok, msg, ts}
const FETCH_TTL_MS   = 24 * 60 * 60 * 1000;     // 24 hours in ms â€” auto-refresh threshold

// Requests go to our proxy (/api/papers) which forwards them to Semantic Scholar
// server-side, avoiding CORS/SSL issues in the browser.
const API_BASE     = '/api/papers';
const PAPERS_LIMIT = 30;  // max papers to fetch per search

// Default keywords shown when signed out, or seeded on first sign-in
const DEFAULT_KEYWORDS = [
  { text: 'social robots',          active: true },
  { text: 'human-robot interaction', active: true },
  { text: 'emotional contagion',    active: true },
  { text: 'priming public spaces',  active: true },
  { text: 'non-humanoid robots',    active: true },
];

// Fields we want from the API (reduces response size)
const API_FIELDS = 'title,abstract,authors,year,externalIds,url';


// â”€â”€ App State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let keywords = [];   // array of { text: string, active: boolean }
let papers   = [];   // array of paper objects returned from API + our score
let loading  = false;


// â”€â”€ Initialise â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function init() {
  // Render signed-out UI immediately (auth observer will update it once Firebase resolves)
  renderAuthUI();
  loadKeywords();   // load defaults so the feed isn't blank while auth resolves
  loadTheme();
  bindEvents();
  renderHealthBar(); // show last known health state immediately while loading
  smartRefresh();    // fetch papers right away
}


// â”€â”€ Auth UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Renders the correct auth widget into #authArea based on currentUser.
function renderAuthUI() {
  const area = document.getElementById('authArea');
  if (!area) return;

  if (currentUser) {
    // Signed in: show avatar + name + sign-out link
    const photo    = currentUser.photoURL;
    const name     = currentUser.displayName || currentUser.email || 'User';
    const initials = name.charAt(0).toUpperCase();

    const avatarHtml = photo
      ? `<img class="user-avatar" src="${esc(photo)}" alt="${esc(name)}" referrerpolicy="no-referrer">`
      : `<span class="user-avatar-fallback">${esc(initials)}</span>`;

    area.innerHTML = `
      <div class="auth-user">
        ${avatarHtml}
        <span class="user-name" title="${esc(name)}">${esc(name)}</span>
        <button class="btn-signout" id="signOutBtn">Sign out</button>
      </div>`;

    document.getElementById('signOutBtn').addEventListener('click', signOut);

    // Show add-keyword row, hide notice
    const row    = document.getElementById('addKeywordRow');
    const notice = document.getElementById('signinNotice');
    if (row)    row.classList.remove('disabled');
    if (notice) notice.style.display = 'none';

  } else {
    // Signed out: show Google sign-in button
    area.innerHTML = `
      <button class="btn-signin" id="signInBtn">
        <svg width="16" height="16" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
          <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
          <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path d="M3.964 10.706A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.706V4.962H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.038l3.007-2.332z" fill="#FBBC05"/>
          <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.962L3.964 7.294C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        Sign in with Google
      </button>`;

    document.getElementById('signInBtn').addEventListener('click', signIn);

    // Dim add-keyword row, show sign-in notice
    const row    = document.getElementById('addKeywordRow');
    const notice = document.getElementById('signinNotice');
    if (row)    row.classList.add('disabled');
    if (notice) notice.style.display = 'block';
  }
}

// Open Google sign-in popup
function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    console.error('Sign-in error:', err);
  });
}

// Sign the user out
function signOut() {
  auth.signOut().catch(err => {
    console.error('Sign-out error:', err);
  });
}


// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Reference to the signed-in user's Firestore document
function userDocRef() {
  return db.collection('users').doc(currentUser.uid);
}

// Load this user's keywords from Firestore.
// On first sign-in (no document yet), seeds with DEFAULT_KEYWORDS.
async function loadKeywordsFromFirestore() {
  try {
    const snap = await userDocRef().get();
    if (snap.exists && snap.data().keywords) {
      keywords = snap.data().keywords;
    } else {
      // First time this user signs in â€” seed with defaults and save
      keywords = DEFAULT_KEYWORDS.map(k => ({ ...k }));
      await saveKeywordsToFirestore();
    }
  } catch (e) {
    console.error('Firestore load error:', e);
    // Fall back to defaults so the app is still usable
    keywords = DEFAULT_KEYWORDS.map(k => ({ ...k }));
  }
}

// Save the current keywords array to Firestore (merge so other fields aren't overwritten)
async function saveKeywordsToFirestore() {
  try {
    await userDocRef().set({ keywords }, { merge: true });
  } catch (e) {
    console.error('Firestore save error:', e);
  }
}


// â”€â”€ Auth state observer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// This is the central controller for sign-in / sign-out.
// Fires once on page load (with the current auth state) and
// again whenever the user signs in or out.

auth.onAuthStateChanged(async (user) => {
  currentUser = user;

  if (user) {
    // Signed in â€” load this user's keywords from Firestore
    await loadKeywordsFromFirestore();
  } else {
    // Signed out â€” reset to defaults (read-only view)
    keywords = DEFAULT_KEYWORDS.map(k => ({ ...k }));
  }

  renderAuthUI();
  renderKeywordChips();
  renderActiveKeywordsBar();

  // Re-score any papers already on screen with the updated keyword set
  if (papers.length > 0) {
    papers = papers.map(p => ({ ...p, score: scorepaper(p) })).sort((a, b) => b.score - a.score);
    renderPapers();
  }
});


// â”€â”€ localStorage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Load keywords for the initial (pre-auth) render.
// The auth observer will overwrite these once Firebase resolves.
function loadKeywords() {
  keywords = DEFAULT_KEYWORDS.map(k => ({ ...k }));
}

// Save keywords: routes to Firestore when signed in, no-op when signed out.
// (Signed-out users view a read-only feed â€” their changes are not persisted.)
function saveKeywords() {
  if (currentUser) {
    saveKeywordsToFirestore(); // async, runs in background
  }
  // No localStorage save â€” keywords are owned by Firestore when signed in
}

function loadTheme() {
  const saved = localStorage.getItem(THEME_KEY) || 'light';
  applyTheme(saved);
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeBtn').textContent = theme === 'dark' ? 'â˜€' : 'ğŸŒ™';
  localStorage.setItem(THEME_KEY, theme);
}


// â”€â”€ Smart refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// Always fetches papers on load (papers aren't cached in localStorage,
// only the timestamp is). The "last updated" time is shown in the status
// bar so you can see at a glance whether the feed is fresh.

function smartRefresh() {
  fetchPapers(); // always fetch on load â€” server cache makes this fast
}

// Returns a human-friendly relative time string, e.g. "2 hours ago", "just now"
function friendlyTime(date) {
  const diff = Math.floor((Date.now() - date.getTime()) / 1000); // seconds
  if (diff < 60)           return 'just now';
  if (diff < 3600)         return `${Math.floor(diff / 60)} min ago`;
  if (diff < 86400)        return `${Math.floor(diff / 3600)} hr ago`;
  return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}


// â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// Runs once on app load (called from fetchPapers on success).
// Checks that the API returned at least one valid paper and saves the result.

async function runHealthCheck() {
  const firstKeyword = activeKeywords()[0];
  if (!firstKeyword) return; // nothing to check

  let ok  = false;
  let msg = '';

  try {
    const params = new URLSearchParams({
      query:  firstKeyword,
      fields: 'title,year',
      limit:  1,
    });
    const res  = await fetch(`${API_BASE}?${params}`);
    const data = await res.json();

    if (res.status === 429 || (data.message && !data.data)) {
      msg = 'API rate-limited';
    } else if (!res.ok) {
      msg = `API error (HTTP ${res.status})`;
    } else if (!data.data || data.data.length === 0) {
      msg = 'API returned no papers';
    } else if (!data.data[0].title) {
      msg = 'API returned malformed data';
    } else {
      ok  = true;
      msg = 'All systems good';
    }
  } catch (e) {
    msg = e.message === 'Failed to fetch' ? 'Cannot reach API' : e.message;
  }

  // Save result to localStorage with timestamp
  const result = { ok, msg, ts: new Date().toISOString() };
  localStorage.setItem(HEALTH_KEY, JSON.stringify(result));
  renderHealthBar(result);
}

// Render the health bar in the footer.
// If called with no argument, reads last saved result from localStorage.
function renderHealthBar(result) {
  if (!result) {
    try {
      const saved = localStorage.getItem(HEALTH_KEY);
      if (!saved) return;
      result = JSON.parse(saved);
    } catch (e) { return; }
  }

  const el = document.getElementById('healthBar');
  if (!el) return;

  const time = friendlyTime(new Date(result.ts));
  el.style.display = 'inline-block';
  el.className = 'health-bar ' + (result.ok ? 'ok' : 'error');
  el.textContent = result.ok
    ? `âœ… ${result.msg} â€” last checked ${time}`
    : `âŒ ${result.msg} â€” last checked ${time}`;
}


// â”€â”€ Event binding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function bindEvents() {
  // Settings panel open/close
  document.getElementById('settingsToggle').addEventListener('click', () => {
    document.getElementById('settingsPanel').classList.toggle('open');
    renderKeywordChips();
  });

  // Refresh button
  document.getElementById('refreshBtn').addEventListener('click', fetchPapers);

  // Theme toggle
  document.getElementById('themeBtn').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
  });

  // Add keyword on button click
  document.getElementById('addKeywordBtn').addEventListener('click', addKeyword);

  // Add keyword on Enter key in input
  document.getElementById('newKeywordInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') addKeyword();
  });
}


// â”€â”€ Keyword management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addKeyword() {
  // Silently block if signed out (the row is visually dimmed anyway)
  if (!currentUser) return;

  const input = document.getElementById('newKeywordInput');
  const text  = input.value.trim().toLowerCase();

  if (!text) return;

  // Don't add duplicates (case-insensitive)
  if (keywords.some(k => k.text === text)) {
    input.value = '';
    return;
  }

  keywords.push({ text, active: true });
  saveKeywords();
  input.value = '';
  renderKeywordChips();
  renderActiveKeywordsBar();
}

function removeKeyword(index) {
  if (!currentUser) return; // read-only when signed out
  keywords.splice(index, 1);
  saveKeywords();
  renderKeywordChips();
  renderActiveKeywordsBar();
}

function toggleKeyword(index) {
  // Toggling is allowed even when signed out (just not persisted)
  keywords[index].active = !keywords[index].active;
  saveKeywords();
  renderKeywordChips();
  renderActiveKeywordsBar();
  // Re-score displayed papers with the updated active keywords
  // (no new network request needed â€” just re-render with new scores)
  if (papers.length > 0) renderPapers();
}

// Returns only active keywords
function activeKeywords() {
  return keywords.filter(k => k.active).map(k => k.text);
}


// â”€â”€ Relevance scoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// Score is 1â€“5 based on how many active keyword phrases appear
// in the paper's title and abstract (title matches count double).
// Returns an integer 1â€“5.

function scorepaper(paper) {
  const active  = activeKeywords();
  if (active.length === 0) return 1;

  const title    = (paper.title    || '').toLowerCase();
  const abstract = (paper.abstract || '').toLowerCase();

  let matches = 0;

  for (const kw of active) {
    const kwLower = kw.toLowerCase();
    if (title.includes(kwLower))    matches += 2; // title is more signal
    if (abstract.includes(kwLower)) matches += 1;
  }

  // Normalise to 1â€“5 range
  // Max possible = active.length * 3 (title + abstract + title double)
  const max   = active.length * 3;
  const ratio = matches / max;

  if (ratio === 0)    return 1;
  if (ratio < 0.1)    return 1;
  if (ratio < 0.25)   return 2;
  if (ratio < 0.5)    return 3;
  if (ratio < 0.75)   return 4;
  return 5;
}


// â”€â”€ API fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// Fetches papers from Semantic Scholar one keyword at a time,
// with a short delay between requests to avoid rate limiting.
// Results are merged and deduplicated by paperId, then scored.
// Docs: https://api.semanticscholar.org/api-docs/

// Fetch a single keyword query. Returns an array of paper objects,
// or throws if the request fails or is rate-limited.
async function fetchOneKeyword(keyword) {
  const params = new URLSearchParams({
    query:  keyword,
    fields: API_FIELDS,
    limit:  10,  // 10 per keyword Ã— up to 5 keywords = up to 50 results
  });

  const res  = await fetch(`${API_BASE}?${params}`);
  const data = await res.json();

  // 429 = rate limited, 503 = API down
  if (res.status === 429 || (data.message && !data.data)) {
    throw new Error('Rate limited by Semantic Scholar. Wait 30 seconds and click Refresh.');
  }
  if (!res.ok) {
    throw new Error(`Semantic Scholar API error (${res.status}). Try again shortly.`);
  }

  return data.data || [];
}

// Small helper: wait ms milliseconds
function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function fetchPapers() {
  if (loading) return;

  const active = activeKeywords();

  if (active.length === 0) {
    setStatus('No active keywords. Enable at least one keyword in settings.', true);
    return;
  }

  loading = true;
  setStatus(`Fetching papers for ${active.length} keyword${active.length > 1 ? 's' : ''}â€¦`);
  showSkeletons();
  setRefreshSpinning(true);

  try {
    const seen    = new Set();  // track paperIds to avoid duplicates
    const results = [];

    // Fetch each keyword sequentially with a 500ms gap to stay under rate limits
    for (let i = 0; i < active.length; i++) {
      if (i > 0) await wait(500);

      setStatus(`Fetching papersâ€¦ (${i + 1}/${active.length})`);

      try {
        const batch = await fetchOneKeyword(active[i]);
        for (const paper of batch) {
          if (paper.title && paper.paperId && !seen.has(paper.paperId)) {
            seen.add(paper.paperId);
            results.push(paper);
          }
        }
      } catch (kwErr) {
        // One keyword failed (e.g. rate limit) â€” skip it and continue with the rest
        console.warn(`Skipping keyword "${active[i]}" due to error: ${kwErr.message}`);
      }
    }

    // Score and sort all collected papers
    papers = results
      .map(p => ({ ...p, score: scorepaper(p) }))
      .sort((a, b) => b.score - a.score);

    if (papers.length === 0) {
      setStatus('No papers found. The API may be rate-limited â€” wait 30 seconds and click Refresh.', true);
    } else {
      // Record timestamp of this successful fetch
      const now = new Date();
      localStorage.setItem(LAST_FETCH_KEY, now.toISOString());
      setStatus(`Showing ${papers.length} papers â€” last updated ${now.toLocaleTimeString()}`);
      // Run health check after a successful fetch (non-blocking, updates footer)
      runHealthCheck();
    }
    renderPapers();

  } catch (err) {
    console.error('Fetch error:', err);
    // "Failed to fetch" here means the local server isn't running
    const msg = err.message === 'Failed to fetch'
      ? 'Could not reach local server. Make sure server.py is running.'
      : err.message;
    setStatus(msg, true);
    document.getElementById('paperFeed').innerHTML = '';
  } finally {
    loading = false;
    setRefreshSpinning(false);
  }
}


// â”€â”€ Rendering helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Escape HTML to prevent XSS when inserting user-supplied or API text
function esc(str) {
  return (str || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function setStatus(msg, isError = false) {
  const el = document.getElementById('statusBar');
  el.textContent = msg;
  el.className   = 'status-bar' + (isError ? ' error' : '');
}

function setRefreshSpinning(on) {
  document.getElementById('refreshIcon').className = on ? 'btn-spinning' : '';
}

// Show 4 skeleton placeholder cards while loading
function showSkeletons() {
  const feed = document.getElementById('paperFeed');
  feed.innerHTML = Array.from({ length: 4 }, () => `
    <div class="skeleton-card">
      <div class="skeleton-line" style="width:70%; height:18px;"></div>
      <div class="skeleton-line" style="width:40%; height:12px;"></div>
      <div class="skeleton-line" style="width:100%; height:12px;"></div>
      <div class="skeleton-line" style="width:95%; height:12px;"></div>
      <div class="skeleton-line" style="width:80%; height:12px;"></div>
    </div>
  `).join('');
}


// â”€â”€ Render: keyword chips in settings panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderKeywordChips() {
  const list = document.getElementById('keywordList');

  if (keywords.length === 0) {
    list.innerHTML = '<span style="color:var(--text-muted);font-size:0.8rem;">No keywords yet.</span>';
    return;
  }

  list.innerHTML = keywords.map((kw, i) => `
    <span class="keyword-chip ${kw.active ? '' : 'off'}"
          data-index="${i}"
          role="button"
          tabindex="0"
          title="${kw.active ? 'Click to disable' : 'Click to enable'}"
          aria-pressed="${kw.active}">
      ${esc(kw.text)}
      <button class="remove-btn"
              data-remove="${i}"
              title="Remove keyword"
              aria-label="Remove ${esc(kw.text)}">Ã—</button>
    </span>
  `).join('');

  // Toggle active/off on chip click (but not on the Ã— button)
  list.querySelectorAll('.keyword-chip').forEach(chip => {
    chip.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-btn')) return;
      toggleKeyword(parseInt(chip.dataset.index));
    });
    // Keyboard accessibility
    chip.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleKeyword(parseInt(chip.dataset.index));
      }
    });
  });

  // Remove keyword on Ã— click
  list.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      removeKeyword(parseInt(btn.dataset.remove));
    });
  });
}


// â”€â”€ Render: active keyword tags below header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderActiveKeywordsBar() {
  const bar    = document.getElementById('activeKeywordsBar');
  const active = activeKeywords();

  if (active.length === 0) {
    bar.innerHTML = '<span class="bar-label">No active keywords</span>';
    return;
  }

  bar.innerHTML =
    '<span class="bar-label">Searching:</span>' +
    active.map(k => `<span class="active-kw-tag">${esc(k)}</span>`).join('');
}


// â”€â”€ Render: paper cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPapers() {
  const feed = document.getElementById('paperFeed');

  if (papers.length === 0) {
    feed.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“„</div>
        No papers found for these keywords. Try adding broader terms.
      </div>`;
    return;
  }

  feed.innerHTML = papers.map((paper, idx) => {
    // Build a URL: prefer the paper's own URL, fall back to S2 search
    const paperUrl = paper.url ||
      (paper.externalIds?.DOI
        ? `https://doi.org/${paper.externalIds.DOI}`
        : `https://www.semanticscholar.org/paper/${paper.paperId || ''}`);

    // Format authors: show up to 4, then "et al."
    const authors = (paper.authors || []).map(a => a.name);
    const authorStr = authors.length > 4
      ? authors.slice(0, 4).join(', ') + ' et al.'
      : authors.join(', ') || 'Unknown authors';

    const year = paper.year || 'Year unknown';

    // Score badge CSS class
    const scoreClass = paper.score >= 4 ? 'high' : paper.score >= 2 ? 'mid' : '';

    // Abstract: show even if empty
    const abstract = paper.abstract
      ? esc(paper.abstract)
      : '<em style="color:var(--text-muted)">No abstract available.</em>';

    return `
      <article class="paper-card" data-idx="${idx}">
        <div class="paper-card-top">
          <h2 class="paper-title">
            <a href="${esc(paperUrl)}" target="_blank" rel="noopener">
              ${esc(paper.title)}
            </a>
          </h2>
          <span class="score-badge ${scoreClass}"
                title="Relevance score based on keyword matches">
            â˜… ${paper.score}/5
          </span>
        </div>
        <div class="paper-meta">
          ${esc(authorStr)} &nbsp;Â·&nbsp; ${esc(String(year))}
        </div>
        <p class="paper-abstract" id="abstract-${idx}">${abstract}</p>
        ${paper.abstract && paper.abstract.length > 300
          ? `<button class="expand-btn" data-idx="${idx}">Show more</button>`
          : ''}
      </article>
    `;
  }).join('');

  // Wire up expand/collapse buttons
  feed.querySelectorAll('.expand-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx      = btn.dataset.idx;
      const absEl    = document.getElementById(`abstract-${idx}`);
      const expanded = absEl.classList.toggle('expanded');
      btn.textContent = expanded ? 'Show less' : 'Show more';
    });
  });
}


// â”€â”€ Start the app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
renderKeywordChips();
renderActiveKeywordsBar();

</script>
</body>
</html>
